name: Deploy

on:
  release:
    types: [published]

# Prevent concurrent deployments
concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GCP_PROJECT_ID: gtfs-archiver
  GCP_REGION: us-central1
  GCS_BUCKET_RT_PROTOBUF: protobuf.gtfsrt.io
  GCS_BUCKET_RT_PARQUET: parquet.gtfsrt.io
  SERVICE_NAME: gtfs-rt-archiver

jobs:
  build-archiver:
    name: Build and Push Archiver Container
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  build-dagster:
    name: Build and Push Dagster Containers
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        target: [webserver, daemon, code-server]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/dagster-${{ matrix.target }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=

      - name: Build and push Dagster ${{ matrix.target }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.dagster
          target: ${{ matrix.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=dagster-${{ matrix.target }}
          cache-to: type=gha,mode=max,scope=dagster-${{ matrix.target }}
          platforms: linux/amd64,linux/arm64

  deploy:
    name: Deploy to Cloud Run
    needs: [build-archiver, build-dagster]
    runs-on: ubuntu-latest
    # Only deploy non-prerelease releases
    if: ${{ !github.event.release.prerelease }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions/providers/github-provider
          service_account: github-actions-deploy@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Setup ASDF
        uses: asdf-vm/actions/setup@v4

      - name: Restore ASDF tools from cache
        id: asdf-tools-cache
        uses: actions/cache@v5
        with:
          key: asdf-tools-${{ hashFiles('.tool-versions') }}
          restore-keys: |
            asdf-tools-
          path: |
            ${{ env.ASDF_DIR }}/plugins
            ${{ env.ASDF_DIR }}/installs

      - name: Install ASDF tools on cache miss
        if: ${{ steps.asdf-tools-cache.outputs.cache-hit != 'true' }}
        uses: asdf-vm/actions/install@v4

      - name: Reshim ASDF tools
        shell: bash
        run: asdf reshim

      - name: Extract version from release tag
        id: version
        run: |
          # Release tag is like v1.2.3
          VERSION="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          # Lowercase the repository name (GHCR normalizes to lowercase)
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          AR_IMAGE="us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ghcr-remote/${REPO_LOWER}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "image=${AR_IMAGE}:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "dagster_webserver_image=${AR_IMAGE}/dagster-webserver:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "dagster_daemon_image=${AR_IMAGE}/dagster-daemon:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "dagster_code_server_image=${AR_IMAGE}/dagster-code-server:${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Initialize Terraform
        working-directory: tf
        run: tofu init

      - name: Plan deployment
        working-directory: tf
        run: |
          tofu plan -concise \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="protobuf_bucket_name=${{ env.GCS_BUCKET_RT_PROTOBUF }}" \
            -var="parquet_bucket_name=${{ env.GCS_BUCKET_RT_PARQUET }}" \
            -var="container_image=${{ steps.version.outputs.image }}" \
            -var="dagster_webserver_image=${{ steps.version.outputs.dagster_webserver_image }}" \
            -var="dagster_daemon_image=${{ steps.version.outputs.dagster_daemon_image }}" \
            -var="dagster_code_server_image=${{ steps.version.outputs.dagster_code_server_image }}" \
            -var="dagster_iap_allowed_domain=${{ vars.DAGSTER_IAP_ALLOWED_DOMAIN }}" \
            -out=tfplan

      - name: Apply deployment
        working-directory: tf
        run: tofu apply -concise -auto-approve tfplan

      - name: Verify deployment health
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          echo "Service URL: $SERVICE_URL"
          echo "Waiting for service to become healthy..."

          for i in {1..30}; do
            if curl -sf "${SERVICE_URL}/health" > /dev/null 2>&1; then
              echo "Service is healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready yet..."
            sleep 10
          done

          echo "Error: Service did not become healthy within 5 minutes"
          exit 1

      - name: Post deployment summary
        if: success()
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')

          echo "## Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Image**: \`${{ steps.version.outputs.image }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Service URL**: ${SERVICE_URL}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Health Check**: ${SERVICE_URL}/health" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Metrics**: ${SERVICE_URL}/metrics" >> "$GITHUB_STEP_SUMMARY"
